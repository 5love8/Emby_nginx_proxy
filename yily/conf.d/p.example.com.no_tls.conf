server {
    listen 443;
    listen [::]:443;
    http2 on;

    server_name                p.example.com; # Replace with your domain, e.g., myproxy.com

    resolver                   1.1.1.1 223.5.5.5 8.8.8.8  valid=60s;
    resolver_timeout           5s;

    client_header_timeout      1h;
    keepalive_timeout          30m;
    client_header_buffer_size  8k;

    # Block web access
    location ~ ^/(?:$|web(?:/.*)?)$ {
        return 403;
    }

    # Backend streaming proxy
    location ~  ^/backstream/([^/]+)  {
        set $website                          $1;
        rewrite ^/backstream/([^/]+)(/.+)$    $2 break;
        proxy_pass                            https://$website; # Change to http:// if backend uses HTTP
        resolver                              1.1.1.1 223.5.5.5 8.8.8.8;

        proxy_set_header Host                 $proxy_host;

        proxy_http_version                    1.1;
        proxy_cache_bypass                    $http_upgrade;
        proxy_ssl_server_name                 on;

        proxy_set_header Upgrade              $http_upgrade;
        proxy_set_header Connection           $connection_upgrade;
        proxy_set_header X-Real-IP            $remote_addr;
        proxy_set_header Forwarded            $proxy_add_forwarded;
        proxy_set_header X-Forwarded-For      $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto    $scheme;
        proxy_set_header X-Forwarded-Host     $host;
        proxy_set_header X-Forwarded-Port     $server_port;

        proxy_connect_timeout                 60s;
        proxy_send_timeout                    60s;
        proxy_read_timeout                    60s;
    }

    # Frontend proxy
    location / {
        proxy_pass                            https://emby.example.com; # Replace with frontend domain
        resolver                              1.1.1.1 223.5.5.5 8.8.8.8;

        proxy_set_header Host                 $proxy_host;

        proxy_http_version                    1.1;
        proxy_cache_bypass                    $http_upgrade;

        proxy_ssl_server_name                 on;

        proxy_set_header Upgrade              $http_upgrade;
        proxy_set_header Connection           $connection_upgrade;
        proxy_set_header X-Real-IP            $remote_addr;
        proxy_set_header Forwarded            $proxy_add_forwarded;
        proxy_set_header X-Forwarded-For      $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto    $scheme;
        proxy_set_header X-Forwarded-Host     $host;
        proxy_set_header X-Forwarded-Port     $server_port;
        
        proxy_connect_timeout                 60s;
        proxy_send_timeout                    60s;
        proxy_read_timeout                    60s;
        
        proxy_redirect ~^(https?)://([^:/]+(?::\d+)?)(/.+)$ $scheme://$server_name:$server_port/backstream/$2$3;
        set $rediret_scheme $1;
        set $rediret_host $2;
        sub_filter                            $proxy_host $host;
        sub_filter '$rediret_scheme://$rediret_host' '$scheme://$server_name:$server_port/backstream/$rediret_host';
        sub_filter_once                       off;
        proxy_intercept_errors on;
        error_page 307 = @handle_redirect;
    }

    location @handle_redirect {
        set $saved_redirect_location '$upstream_http_location';
        proxy_pass $saved_redirect_location;
        resolver                              1.1.1.1 223.5.5.5 8.8.8.8;
        proxy_set_header Host                 $proxy_host;
        proxy_http_version                    1.1;
        proxy_cache_bypass                    $http_upgrade;

        proxy_ssl_server_name                 on;

        proxy_set_header Upgrade              $http_upgrade;
        proxy_set_header Connection           $connection_upgrade;
        proxy_set_header X-Real-IP            $remote_addr;
        proxy_set_header Forwarded            $proxy_add_forwarded;
        proxy_set_header X-Forwarded-For      $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto    $scheme;
        proxy_set_header X-Forwarded-Host     $host;
        proxy_set_header X-Forwarded-Port     $server_port;
        
        proxy_connect_timeout                 60s;
        proxy_send_timeout                    60s;
        proxy_read_timeout                    60s;
    }
}
